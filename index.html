<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAGAYA: Cyber-Connect 2099</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/050505/00f3ff?text=Èï∑Â±ã">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.opalrb.com/opal/current/opal.min.js"></script>
    <script src="https://cdn.opalrb.com/opal/current/opal-parser.min.js"></script>
    <script src="https://cdn.opalrb.com/opal/current/opal-jquery.min.js"></script>
    
    <style>
        :root {
            --urushi-black: #050505;
            --neon-cyan: #00f3ff;
            --neon-magenta: #ff0055;
            --shrine-red: #c41a1a;
        }

        body {
            background-color: var(--urushi-black);
            color: #eee;
            font-family: 'Courier New', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #nagaya-app {
            width: 100%;
            max-width: 450px;
            height: 90vh;
            border: 2px solid var(--neon-cyan);
            border-radius: 10px;
            box-shadow: 0 0 20px var(--neon-cyan);
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.95);
        }

        .engawa-header {
            padding: 15px;
            border-bottom: 1px solid var(--neon-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title { color: var(--neon-cyan); font-weight: bold; letter-spacing: 2px; }
        .sub-title { font-size: 0.7rem; color: var(--neon-magenta); }

        #chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg { padding: 10px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; }
        .msg-user { align-self: flex-end; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); }
        .msg-ai { align-self: flex-start; border: 1px solid var(--shrine-red); color: white; }
        .msg-ai::before { content: "„ÄêÂ§ßÂÆ∂‰ªãÂÖ•„Äë"; display: block; font-size: 0.6rem; color: var(--shrine-red); }

        .input-area { padding: 15px; border-top: 1px solid var(--neon-cyan); display: flex; }
        input { flex-grow: 1; background: #111; border: 1px solid #333; color: var(--neon-cyan); padding: 10px; }
        button { background: var(--neon-cyan); border: none; padding: 10px; margin-left: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="nagaya-app">
    <div class="engawa-header">
        <div>
            <div class="title">ÈõªËÑ≥Èï∑Â±ã</div>
            <div class="sub-title">‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï ‡¶¨‡¶∏‡ßç‡¶§‡¶ø</div>
        </div>
        <div style="color:var(--shrine-red)">üèÆ <span id="karma-display">Âæ≥:00</span></div>
    </div>

    <div id="chat-area">
        <div class="msg msg-ai">
            „Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï: ÂÖ•Â±ÖÂÆå‰∫Ü„ÄÇ<br>
            Èö£‰∫∫„Å®ÂØæË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
            (Try: "I want money" or "Let's help")
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Message..." autocomplete="off">
        <button id="send-btn">SEND</button>
    </div>
</div>

<script type="text/ruby">
require 'opal'
require 'opal-jquery'

class Landlord
  def evaluate(text)
    if text.match?(/money|rich|Èáë|Á®º/i)
      return { msg: "„ÄéÈáë„Äè„Çà„Çä„ÄéÂæ≥„Äè„ÇíÁ©ç„Åø„Å™„Åï„ÅÑ„ÄÇ\nMoney follows Karma.", karma: -2 }
    end
    if text.match?(/help|share|Âä©|Êâã‰ºù/i)
      return { msg: "ÊÑüÂøÉ„Åò„ÇÉ„ÄÇ„Åù„ÅÆÂøÉ„ÄÅ„É©„É≥„Çø„É≥„ÅÆÂ¶Ç„Åó„ÄÇ\nGreat spirit.", karma: 5 }
    end
    if text.match?(/alone|Ëá™ÂàÜ|myself/i)
      return { msg: "Â≠§È´ò„ÇÇËâØ„ÅÑ„Åå„ÄÅ„Åü„Åæ„Å´„ÅØÈ†º„Çä„Å™„Åï„ÅÑ„ÄÇ\nDon't be alone.", karma: 0 }
    end
    nil
  end
end

class App
  def initialize
    @landlord = Landlord.new
    @karma = 0
    
    Element.find('#send-btn').on(:click) { send_msg }
    # Enter„Ç≠„ÉºÂØæÂøú
    Element.find('#user-input').on(:keydown) do |e|
      send_msg if e.key_code == 13
    end
  end

  def send_msg
    input = Element.find('#user-input')
    text = input.value
    return if text.strip.empty?

    add_bubble(text, 'msg-user')
    input.value = ""

    # AIÂà§ÂÆö
    result = @landlord.evaluate(text)
    if result
      # Â∞ë„ÅóÈÅÖ„Çå„Å¶Â§ßÂÆ∂„ÅåÁôªÂ†¥
      $$[:window].setTimeout(-> { 
        add_bubble(result[:msg], 'msg-ai')
        update_karma(result[:karma])
      }, 600)
    end
  end

  def add_bubble(text, cls)
    chat = Element.find('#chat-area')
    div = Element.new(:div)
    div.add_class('msg')
    div.add_class(cls)
    div.html = text.gsub("\n", "<br>")
    chat.append(div)
    # „Çπ„ÇØ„É≠„Éº„É´
    chat.prop(:scrollTop, chat.prop(:scrollHeight))
  end

  def update_karma(delta)
    @karma += delta
    Element.find('#karma-display').text = "Âæ≥:#{@karma.to_s.rjust(2, '0')}"
  end
end

Document.ready? do
  App.new
end
</script>

</body>
</html>
