<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAGAYA: Cyber-Connect 2099</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/050505/00f3ff?text=é•·å±‹">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.opalrb.com/opal/current/opal.min.js"></script>
    <script src="https://cdn.opalrb.com/opal/current/opal-parser.min.js"></script>
    
    <style>
        :root {
            --urushi-black: #050505;
            --neon-cyan: #00f3ff;
            --neon-magenta: #ff0055;
            --shrine-red: #c41a1a;
        }
        body {
            background-color: var(--urushi-black);
            color: #eee;
            font-family: 'Courier New', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #nagaya-app {
            width: 100%;
            max-width: 450px;
            height: 90vh;
            border: 2px solid var(--neon-cyan);
            border-radius: 10px;
            box-shadow: 0 0 20px var(--neon-cyan);
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 10, 0.95);
        }
        .engawa-header {
            padding: 15px;
            border-bottom: 1px solid var(--neon-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title { color: var(--neon-cyan); font-weight: bold; letter-spacing: 2px; }
        .sub-title { font-size: 0.7rem; color: var(--neon-magenta); }
        #chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .msg { padding: 10px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; }
        .msg-user { align-self: flex-end; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); }
        .msg-ai { align-self: flex-start; border: 1px solid var(--shrine-red); color: white; }
        .msg-ai::before { content: "ã€å¤§å®¶ä»‹å…¥ã€‘"; display: block; font-size: 0.6rem; color: var(--shrine-red); }
        .input-area { padding: 15px; border-top: 1px solid var(--neon-cyan); display: flex; }
        input { flex-grow: 1; background: #111; border: 1px solid #333; color: var(--neon-cyan); padding: 10px; }
        button { background: var(--neon-cyan); border: none; padding: 10px; margin-left: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="nagaya-app">
    <div class="engawa-header">
        <div>
            <div class="title">é›»è„³é•·å±‹</div>
            <div class="sub-title">à¦‡à¦²à§‡à¦•à¦Ÿà§à¦°à¦¨à¦¿à¦• à¦¬à¦¸à§à¦¤à¦¿</div>
        </div>
        <div style="color:var(--shrine-red)">ğŸ® <span id="karma-display">å¾³:00</span></div>
    </div>

    <div id="chat-area">
        <div class="msg msg-ai">
            ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•...<br>
            å…¥å±…å®Œäº†ã€‚<br>
            (Try: "I want money" or "help")
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Message..." autocomplete="off">
        <button id="send-btn">SEND</button>
    </div>
</div>

<script type="text/ruby">
require 'native'

# ãƒ–ãƒ©ã‚¦ã‚¶ã®æ©Ÿèƒ½ã‚’Rubyã§ä½¿ã†ãŸã‚ã®æº–å‚™
$window = $$
$document = $window.document

class Landlord
  def evaluate(text)
    if text.match?(/money|rich|é‡‘|ç¨¼/i)
      return { msg: "ã€é‡‘ã€ã‚ˆã‚Šã€å¾³ã€ã‚’ç©ã¿ãªã•ã„ã€‚\nMoney follows Karma.", karma: -2 }
    end
    if text.match?(/help|share|åŠ©|æ‰‹ä¼/i)
      return { msg: "æ„Ÿå¿ƒã˜ã‚ƒã€‚ãã®å¿ƒã€ãƒ©ãƒ³ã‚¿ãƒ³ã®å¦‚ã—ã€‚\nGreat spirit.", karma: 5 }
    end
    if text.match?(/alone|è‡ªåˆ†|myself/i)
      return { msg: "å­¤é«˜ã‚‚è‰¯ã„ãŒã€ãŸã¾ã«ã¯é ¼ã‚Šãªã•ã„ã€‚\nDon't be alone.", karma: 0 }
    end
    nil
  end
end

class App
  def initialize
    @landlord = Landlord.new
    @karma = 0
    
    # UIè¦ç´ ã‚’å–å¾—ï¼ˆã“ã“ã‚’Nativeæ–¹å¼ã«å¤‰æ›´ï¼‰
    @input_el = $document.getElementById('user-input')
    @chat_el = $document.getElementById('chat-area')
    @karma_el = $document.getElementById('karma-display')
    btn_el = $document.getElementById('send-btn')

    # ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    btn_el.addEventListener('click') do
      send_msg
    end

    # ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
    @input_el.addEventListener('keydown') do |e|
      # Nativeã‚¤ãƒ™ãƒ³ãƒˆã®keyCodeã‚’å–å¾—
      if e[:keyCode].to_i == 13
        send_msg
      end
    end
    
    puts "App Initialized"
  end

  def send_msg
    text = @input_el.value
    return if text.to_s.strip.empty?

    add_bubble(text, 'msg-user')
    @input_el.value = ""

    # AIåˆ¤å®š
    result = @landlord.evaluate(text)
    if result
      # é…å»¶å®Ÿè¡Œ (Native setTimeout)
      $window.setTimeout(-> { 
        add_bubble(result[:msg], 'msg-ai')
        update_karma(result[:karma])
      }, 600)
    end
  end

  def add_bubble(text, cls)
    div = $document.createElement('div')
    div.className = "msg #{cls}"
    div.innerHTML = text.gsub("\n", "<br>")
    @chat_el.appendChild(div)
    # æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    @chat_el.scrollTop = @chat_el.scrollHeight
  end

  def update_karma(delta)
    @karma += delta
    @karma_el.innerText = "å¾³:#{@karma.to_s.rjust(2, '0')}"
  end
end

# ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦èµ·å‹•
$document.addEventListener('DOMContentLoaded') do
  App.new
end
</script>

</body>
</html>
